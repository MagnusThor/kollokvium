!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=function(){function e(e,t,n,r){this.D=t,this.T=e,this.C=n,this.B=r}return Object.defineProperty(e.prototype,"JSON",{get:function(){return{T:this.T,D:JSON.stringify(this.D),C:this.C}},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return JSON.stringify(this.JSON)},e.fromArrayBuffer=function(e){return r.BinaryMessage.fromArrayBuffer(e)},e}();t.TextMessage=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i=n(0),o=function(){function e(e,t){this.arrayBuffer=t,this.header=new Uint8Array(r.Utils.longToArray(e.length)),this.Buffer=this.joinBuffers(this.joinBuffers(this.header.buffer,r.Utils.stingToBuffer(e).buffer),t)}return e.fromArrayBuffer=function(e){var t=new Uint8Array(e),n=t.slice(0,8),o=r.Utils.arrayToLong(n),s=n.byteLength+o,a=t.slice(n.byteLength,s),c=e.byteLength-s,d=t.slice(s,c),u=JSON.parse(String.fromCharCode.apply(null,new Uint16Array(a)));return new i.TextMessage(u.T,u.D,u.C,d)},e.prototype.joinBuffers=function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer},e}();t.BinaryMessage=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.stingToBuffer=function(e){for(var t=e.length,n=new Array(t),r=0;r<t;r++)n[r]=255&e.charCodeAt(r);return new Uint8Array(n)},e.arrayToLong=function(e){for(var t=0,n=e.byteLength-1;n>=0;n--)t=256*t+e[n];return t},e.longToArray=function(e){for(var t=new Uint8Array(8),n=t.length,r=0;r<n;r++){var i=255&e;t[r]=i,e=(e-i)/256}return t},e.newGuid=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e}();t.Utils=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t){this.fn=t,this.topic=e,this.count=0}}();t.Listener=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t){this.videobandwidth=e,this.audiobandwidth=t}}();t.BandwidthConstraints=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=function(){function e(e,t){this.listeners=t||new Array,this.PeerChannels=new Array,this.Name=e}return e.prototype.findListener=function(e){return this.listeners.find(function(t){return t.topic===e})},e.prototype.On=function(e,t){var n=new i.Listener(e,t);return this.listeners.push(n),n},e.prototype.Off=function(e){var t=this.listeners.indexOf(this.findListener(e));t>=0&&this.listeners.splice(t,1)},e.prototype.OnOpen=function(e,t){},e.prototype.OnClose=function(e,t){},e.prototype.onMessage=function(e){var t=JSON.parse(e.data),n=this.findListener(t.T);n&&n.fn.apply(this,[JSON.parse(t.D)])},e.prototype.Close=function(){this.PeerChannels.forEach(function(e){e.dataChannel.close()})},e.prototype.Invoke=function(e,t,n){var i=this;return this.PeerChannels.forEach(function(n){"open"===n.dataChannel.readyState&&n.dataChannel.send(new r.TextMessage(e,t,i.Name).toString())}),this},e.prototype.addPeerChannel=function(e){this.PeerChannels.push(e)},e.prototype.removePeerChannel=function(e){var t=this.PeerChannels.find(function(t){return t.peerId===e}),n=this.PeerChannels.indexOf(t);n>-1&&this.PeerChannels.splice(n,1)},e}();t.DataChannel=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),i=n(3),o=function(){function e(e,t){var n=this;this.alias=e,this.ws=t,this.listeners=new Array,this.IsConnected=!1,this.On("___error",function(e){n.OnError(e)})}return e.prototype.OnError=function(e){},e.prototype.OnOpen=function(e){},e.prototype.OnClose=function(e){},e.prototype.Connect=function(){return this.ws.send(new r.TextMessage("___connect",{},this.alias).toString()),this},e.prototype.Close=function(){return this.ws.send(new r.TextMessage("___close",{},this.alias).toString()),this},e.prototype.Subscribe=function(e,t){return this.ws.send(new r.TextMessage("___subscribe",{topic:e,controller:this.alias},this.alias).toString()),this.On(e,t)},e.prototype.Unsubscribe=function(e){this.ws.send(new r.TextMessage("___unsubscribe",{topic:e,controller:this.alias},this.alias).toString())},e.prototype.On=function(e,t){var n=new i.Listener(e,t);return this.listeners.push(n),n},e.prototype.Off=function(e){var t=this.listeners.indexOf(this.findListener(e));t>=0&&this.listeners.splice(t,1)},e.prototype.findListener=function(e){return this.listeners.find(function(t){return t.topic===e})},e.prototype.InvokeBinary=function(e){if(e instanceof ArrayBuffer)return this.ws.send(e),this;throw"parameter provided must be an ArrayBuffer constructed by Client.BinaryMessage"},e.prototype.PublishBinary=function(e){if(e instanceof ArrayBuffer)return this.ws.send(e),this;throw"parameter provided must be an ArrayBuffer constructed by Client.BinaryMessage"},e.prototype.Invoke=function(e,t,n){return this.ws.send(new r.TextMessage(e,t,n||this.alias).toString()),this},e.prototype.Publish=function(e,t,n){return this.Invoke(e,t,n||this.alias),this},e.prototype.SetProperty=function(e,t,n){return this.Invoke(e,t,n||this.alias),this},e.prototype.Dispatch=function(e,t,n){if("___open"===e)return this.IsConnected=!0,void this.OnOpen(JSON.parse(t));if("___close"===e)this.OnClose([JSON.parse(t)]),this.IsConnected=!1;else{var r=this.findListener(e);r&&r.fn(JSON.parse(t),n)}},e}();t.Controller=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t,n){this.peerId=e,this.dataChannel=t,this.label=n}}();t.PeerChannel=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r{static getCandidate(e){return this.candidates.find(t=>t.label===e)}static tryCandidate(e,t,n){let r={audio:!1,video:{deviceId:e?{exact:e}:void 0,width:{exact:t.width},height:{exact:t.height}}};navigator.mediaDevices.getUserMedia(r).then(e=>{n(t)}).catch(e=>{console.log("non working candidate",t)})}static testResolutions(e,t){let n=0;this.candidates.forEach(r=>{window.setTimeout(()=>{this.tryCandidate(e,this.candidates[n],t),n++},200)})}}r.candidates=[{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9"},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9"},{label:"UXGA",width:1600,height:1200,ratio:"4:3"},{label:"720p(HD)",width:1280,height:720,ratio:"16:9"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p(nHD)",width:640,height:360,ratio:"16:9"},{label:"CIF",width:352,height:288,ratio:"4:3"},{label:"QVGA",width:320,height:240,ratio:"4:3"},{label:"QCIF",width:176,height:144,ratio:"4:3"},{label:"QQVGA",width:160,height:120,ratio:"4:3"}],t.DetectResolutions=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MediaStreamRecorder=class{constructor(e){this.tracks=e,this.mediaStream=new MediaStream(e),this.recorder=new MediaRecorder(this.mediaStream,{mimeType:"video/webm;codecs=vp9"}),this.recorder.ondataavailable=(e=>{e.data.size>0&&this.data.push(e.data)})}getBlobUrl(){let e=new Blob(this.data,{type:"video/webm"});return URL.createObjectURL(e)}getBlob(){return new Blob(this.data,{type:"video/webm"})}flush(){return new Promise((e,t)=>{e(this.getBlobUrl()),this.data=new Array})}stop(){this.recorder.stop()}start(e){this.data=new Array,this.recorder.start(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.StreamSource=class{constructor(e,t,n){this.stream=e,this.source=t,this.isLocal=n}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(12),i=n(18),o=n(19),s=n(20),a=n(22),c=n(24),d=n(8);class u{constructor(){this.rtcConfig={sdpSemantics:"plan-b",iceTransports:"all",rtcpMuxPolicy:"require",bundlePolicy:"max-bundle",iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.appDomain=new a.AppDomain,this.mediaStreamBlender=new c.MediaStreamBlender;let e=document.querySelector("#watermark");this.mediaStreamBlender.onFrameRendered=(t=>{t.save(),t.filter="invert()",t.drawImage(e,10,10,100,100),t.restore()}),this.mediaStreamBlender.onTrack=(()=>{this.audioNode.srcObject=this.mediaStreamBlender.getRemoteAudioStream()}),this.mediaStreamBlender.onRecordingStart=(()=>{this.sendMessage(this.userSettings.nickname,"I'm now recording the session.")}),this.mediaStreamBlender.onRecordingEnded=(e=>{let t=document.createElement("p");const n=document.createElement("a");n.setAttribute("href",e),n.textContent="Your recording has ended, here is the file. ( click to download )",n.setAttribute("download",`${Math.random().toString(36).substring(6)}.webm`),t.append(n),document.querySelector("#recorder-download").append(t),$("#recorder-result").modal("show")}),this.mediaStreamBlender.onTrackEnded=(()=>{this.audioNode.srcObject=this.mediaStreamBlender.getRemoteAudioStream(),this.mediaStreamBlender.refreshCanvas()}),document.querySelector("#appDomain").textContent=this.appDomain.domain,document.querySelector("#appVersion").textContent=this.appDomain.version,this.userSettings=new s.UserSettings,void 0!==window.orientation&&document.querySelector(".only-desktop").classList.add("hide"),location.href.includes("https://")||(this.peerId=null),this.numOfChatMessagesUnread=0,this.participants=new Map,this.Slug=location.hash.replace("#",""),this.fullScreenVideo=document.querySelector(".full"),this.shareContainer=document.querySelector("#share-container"),this.shareFile=document.querySelector("#share-file"),this.videoGrid=document.querySelector("#video-grid"),this.audioNode=document.querySelector("#remtote-audio-nodes audio");let t=document.querySelector("#slug"),n=document.querySelector("#joinconference"),i=document.querySelector(".chat"),d=document.querySelector("#chat-message"),u=document.querySelector("#chat-nick"),l=document.querySelector("#chatmessages"),h=document.querySelector("#mute-local-audio"),f=document.querySelector("#mute-local-video"),p=document.querySelector("#share-screen"),m=document.querySelector("#settings"),v=document.querySelector("#save-settings"),g=document.querySelector("#unread-messages"),y=document.querySelector("#generate-slug"),C=document.querySelector("#txt-nick"),S=document.querySelector("#sel-video"),w=document.querySelector("#sel-audio"),b=document.querySelector("#sel-video-res");document.querySelector("#sel-video-res option").textContent="Using dynamic resolution";let O=document.querySelector(".record"),k=document.querySelector("#test-resolutions");C.value=this.userSettings.nickname,O.addEventListener("click",()=>{O.classList.toggle("flash"),this.mediaStreamBlender.render(60),this.mediaStreamBlender.record()}),k.addEventListener("click",()=>{this.testCameraResolutions()}),this.getMediaDevices().then(e=>{e.filter(e=>e.kind.indexOf("input")>0).forEach((e,t)=>{let n=document.createElement("option");n.textContent=e.label||`Device #${t} (name unknown)`,n.value=e.deviceId,"videoinput"==e.kind?(n.value==this.userSettings.videoDevice&&(n.selected=!0),document.querySelector("#sel-video").append(n)):(n.value==this.userSettings.audioDevice&&(n.selected=!0),document.querySelector("#sel-audio").append(n))}),e.filter(e=>e.kind.indexOf("output")>0).forEach(e=>{let t=document.createElement("option");t.textContent=e.label||e.kind,t.setAttribute("value",e.deviceId),document.querySelector("#sel-audio-out").append(t)}),S.value=this.userSettings.videoDevice,w.value=this.userSettings.audioDevice}).catch(console.error),v.addEventListener("click",()=>{this.userSettings.nickname=C.value,this.userSettings.audioDevice=w.value,this.userSettings.videoDevice=S.value,this.userSettings.videoResolution=b.value,this.userSettings.saveSetting();let e=this.userSettings.createConstraints(this.userSettings.videoResolution);this.localMediaStream.getVideoTracks().forEach(t=>{t.applyConstraints(e.video).then(()=>{}).catch(()=>{console.log("error")})})}),m.addEventListener("click",()=>{$("#settings-modal").modal("toggle")}),$(".modal").on("shown.bs.modal",function(){$(".popover").popover("hide")}),$("#share-file").popover({trigger:"manual",sanitize:!1,placement:"top",title:"Select the file to share.",html:!0,content:$("#share-form").html()}).on("inserted.bs.popover",e=>{$(".file-selected").on("change",e=>{const t=e.target.files[0];o.ReadFile.read(t).then(e=>{this.sendFile({name:e.tf.name,size:e.tf.size,mimeType:e.tf.type},e.buffer),$("#share-file").popover("hide")})})}),this.userSettings.slugHistory.getHistory().forEach(e=>{const t=document.createElement("option");t.setAttribute("value",e),document.querySelector("#slug-history").prepend(t)}),y.addEventListener("click",()=>{t.value=Math.random().toString(36).substring(2).toLocaleLowerCase(),n.disabled=!1,$("#random-slug").popover("hide")}),h.addEventListener("click",e=>{this.muteAudio(e)}),f.addEventListener("click",e=>{this.muteVideo(e)}),p.addEventListener("click",()=>{this.shareScreen()}),this.shareFile.addEventListener("click",()=>{$("#share-file").popover("toggle")}),document.querySelector("button#share-link").addEventListener("click",e=>{navigator.clipboard.writeText(`${location.origin}/#${t.value}`).then(()=>{e.target.textContent="Done!"})}),this.Slug.length>=6&&(t.value=this.Slug,n.disabled=!1,document.querySelector("#random-slug").classList.add("d-none")),document.querySelector("#close-chat").addEventListener("click",()=>{i.classList.toggle("d-none"),g.classList.add("d-none"),this.numOfChatMessagesUnread=0,g.textContent="0"}),document.querySelector("#show-chat").addEventListener("click",()=>{i.classList.toggle("d-none"),g.classList.add("d-none"),this.numOfChatMessagesUnread=0,g.textContent="0"}),t.addEventListener("click",()=>{$("#slug").popover("show"),$("#random-slug").popover("hide")}),0==location.hash.length?$("#random-slug").popover("show"):n.textContent="JOIN",t.addEventListener("keyup",()=>{t.value.length>=6?n.disabled=!1:n.disabled=!0}),u.value=this.userSettings.nickname,u.addEventListener("click",()=>{u.value=""}),n.addEventListener("click",()=>{this.videoGrid.classList.add("d-flex"),document.querySelector("#record").classList.remove("d-none"),$("#random-slug").popover("hide"),document.querySelector("#share-file").classList.toggle("hide"),document.querySelector("#show-chat").classList.toggle("d-none"),document.querySelector(".our-brand").remove(),$("#slug").popover("hide"),n.classList.add("hide"),document.querySelector(".remote").classList.remove("hide"),document.querySelector(".overlay").classList.add("d-none"),document.querySelector(".join").classList.add("d-none"),this.userSettings.slugHistory.addToHistory(t.value),this.userSettings.saveSetting(),this.rtcClient.ChangeContext(this.appDomain.getSlug(t.value))}),this.factory=this.connectToServer(this.appDomain.serverUrl,{}),this.factory.OnClose=(e=>{console.error(e)}),this.factory.OnOpen=(e=>{this.rtcClient=new r.WebRTC(e,this.rtcConfig),e.On("fileShare",(e,t)=>{this.fileReceived(e,t)}),e.On("instantMessage",e=>{this.numOfChatMessagesUnread++;let t=document.createElement("p");t.textContent=e.text;let n=document.createElement("mark");n.textContent=e.from,t.prepend(n),l.prepend(t),i.classList.contains("d-none")&&(g.classList.remove("d-none"),g.textContent=this.numOfChatMessagesUnread.toString())}),d.addEventListener("keyup",e=>{13==e.keyCode&&(this.sendMessage(u.value,d.value),d.value="")}),this.rtcClient.OnLocalStream=(e=>{}),this.rtcClient.OnContextConnected=(e=>{}),this.rtcClient.OnContextCreated=(e=>{}),this.rtcClient.OnContextChanged=(e=>{this.rtcClient.ConnectContext()}),this.rtcClient.OnContextDisconnected=(e=>{document.querySelector(".p"+e.id).remove()}),this.rtcClient.OnContextConnected=(e=>{document.querySelector(".remote").classList.remove("hide")}),this.rtcClient.OnRemoteTrack=((e,t)=>{let n=this.tryAddParticipant(t.id);n.addTrack(e,n=>{this.mediaStreamBlender.addTracks(`audio-${t.id}`,[e],!1)}),n.onVideoTrackLost=((e,t,n)=>{let r=document.querySelector(".p"+e);r&&r.remove()})}),this.rtcClient.OnContextCreated=function(e){},e.OnOpen=(e=>{this.getLocalStream(s.UserSettings.defaultConstraints,e=>{this.localMediaStream=e,this.rtcClient.AddLocalStream(e),this.addLocalVideo(e)})}),e.Connect()})}testCameraResolutions(){let e=document.querySelector("#sel-video-res");e.innerHTML="";let t=document.querySelector("#sel-video").value;d.DetectResolutions.testResolutions(""==t?void 0:t,t=>{let n=document.createElement("option");n.textContent=`${t.label} ${t.width} x ${t.height} ${t.ratio}`,n.value=t.label,e.append(n)}),e.removeAttribute("disabled")}getLocalStream(e,t){navigator.mediaDevices.getUserMedia(e).then(e=>{t(e)}).catch(e=>{console.error(e)})}fileReceived(e,t){const n=document.createElement("p");n.textContent="Hey,here is shared file, click to download.. ";const r=new Blob([t],{type:e.mimeType}),i=window.URL.createObjectURL(r),o=document.createElement("a");o.setAttribute("href",i),o.textContent=e.name,o.setAttribute("download",e.name),n.append(o),document.querySelector("#chatmessages").prepend(n)}sendFile(e,t){var n=new r.Message("fileShare",e,"broker",t);let i=new r.BinaryMessage(n.toString(),t);this.factory.GetController("broker").InvokeBinary(i.Buffer)}shareScreen(){navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!1}).then(e=>{e.getVideoTracks().forEach(e=>{this.rtcClient.LocalStreams[0].addTrack(e)}),this.addLocalVideo(e),document.querySelector("#share-screen").classList.add("hide")}).catch(e=>console.error)}muteVideo(e){let t=e.target;t.classList.toggle("fa-video"),t.classList.toggle("fa-video-slash"),this.localMediaStream.getVideoTracks().forEach(e=>{e.enabled=!e.enabled})}muteAudio(e){let t=e.target;t.classList.toggle("fa-microphone"),t.classList.toggle("fa-microphone-slash"),this.localMediaStream.getAudioTracks().forEach(e=>{e.enabled=!e.enabled})}recordStream(e){}addLocalVideo(e){let t=document.createElement("video");t.autoplay=!0,t.muted=!0,t.classList.add("l-"+e.id),t.srcObject=e,document.querySelector(".local").append(t),this.mediaStreamBlender.addTracks(e.id,e.getTracks(),!0)}sendMessage(e,t){0==e.length&&(e="NoName");const n={text:t,from:e};this.factory.GetController("broker").Invoke("instantMessage",n)}connectToServer(e,t){return new r.Factory(e,["broker"])}addRemoteVideo(e,t){this.shareContainer.classList.contains("hide")||this.shareContainer.classList.add("hide");let n=document.createElement("div");n.classList.add("video-tools");let r=document.createElement("li");r.setAttribute("class","p"+e);let i=document.createElement("i");i.classList.add("fas","fa-arrows-alt","fa-2x","fullscreen"),n.append(i),r.prepend(n);let o=document.createElement("video");o.srcObject=t,o.width=1920,o.height=1080,o.autoplay=!0,r.append(o),i.addEventListener("click",e=>{let t=o;document.fullscreenElement?document.exitFullscreen():t.requestFullscreen().catch(e=>{alert(`Error attempting to enable full-screen mode: ${e.message} (${e.name})`)})}),document.querySelector("#remote-videos").append(r)}getMediaDevices(){return new Promise((e,t)=>{navigator.mediaDevices.enumerateDevices().then(t=>{e(t)}).catch(t)})}tryAddParticipant(e){if(this.participants.has(e))return this.participants.get(e);{this.participants.set(e,new i.AppParticipant(e));let t=this.participants.get(e);return t.onVideoTrackAdded=((e,t,n)=>{this.mediaStreamBlender.addTracks(e,[n],!1),this.addRemoteVideo(e,t)}),t}}static getInstance(){return new u}}t.App=u,document.addEventListener("DOMContentLoaded",()=>{location.href.includes("https://")||location.href.includes("http://localhost")||(location.href=location.href.replace("http://","https://"));let e=u.getInstance();window.app=e})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4);t.BandwidthConstraints=r.BandwidthConstraints;var i=n(1);t.BinaryMessage=i.BinaryMessage;var o=n(5);t.DataChannel=o.DataChannel;var s=n(13);t.Factory=s.Factory;var a=n(0);t.Message=a.TextMessage;var c=n(3);t.Listener=c.Listener;var d=n(7);t.PeerChannel=d.PeerChannel;var u=n(14);t.PropertyMessage=u.PropertyMessage;var l=n(6);t.Proxy=l.Controller;var h=n(2);t.Utils=h.Utils;var f=n(15);t.WebRTC=f.WebRTC},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),i=n(6),o=function(){function e(e,t,n){var o=this;this.url=e,this.controllers=new Map,this.ws=new WebSocket(e+this.toQuery(n||{})),this.ws.binaryType="arraybuffer",t.forEach(function(e){o.controllers.set(e,new i.Controller(e,o.ws))}),this.ws.onmessage=function(e){if("object"!=typeof e.data){var t=JSON.parse(e.data);o.GetController(t.C).Dispatch(t.T,t.D)}else{t=r.BinaryMessage.fromArrayBuffer(e.data);o.GetController(t.C).Dispatch(t.T,t.D,t.B)}},this.ws.onclose=function(e){o.IsConnected=!1,o.OnClose.apply(o,[e])},this.ws.onerror=function(e){o.OnError.apply(o,[e])},this.ws.onopen=function(e){o.IsConnected=!0,o.OnOpen.apply(o,Array.from(o.controllers.values()))}}return e.prototype.toQuery=function(e){return"?"+Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},e.prototype.Close=function(){this.ws.close()},e.prototype.GetController=function(e){return this.controllers.get(e)},e.prototype.RemoveController=function(e){this.controllers.delete(e)},e.prototype.OnOpen=function(e){},e.prototype.OnError=function(e){},e.prototype.OnClose=function(e){},e}();t.Factory=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i=function(){return function(){this.messageId=r.Utils.newGuid()}}();t.PropertyMessage=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(16),i=n(7),o=n(5),s=n(4),a=function(){function e(e,t){var n=this;this.brokerController=e,this.rtcConfig=t,this.Errors=new Array,this.LocalStreams=new Array,this.DataChannels=new Map,this.Peers=new Map,this.brokerController.On("contextSignal",function(e){switch(JSON.parse(e.message).type){case"offer":n.onOffer(e);break;case"answer":n.onAnswer(e);break;case"candidate":n.onCandidate(e)}}),e.On("contextCreated",function(e){n.LocalPeerId=e.peerId,n.Context=e.context,n.OnContextCreated(e)}),e.On("contextChanged",function(e){n.Context=e,n.OnContextChanged(e)}),e.On("connectTo",function(e){n.onConnectTo(e)})}return e.prototype.onConnectTo=function(e){this.Connect(e)},e.prototype.onConnected=function(e){this.OnContextConnected(this.findPeerConnection(e),this.getPeerConnection(e))},e.prototype.OnDisconnected=function(e){var t=this.getPeerConnection(e);this.OnContextDisconnected(this.findPeerConnection(e),t),t.close(),this.removePeerConnection(e)},e.prototype.setBandwithConstraints=function(e,t){this.bandwidthConstraints=new s.BandwidthConstraints(e,t)},e.prototype.setMediaBitrates=function(e){return this.setMediaBitrate(this.setMediaBitrate(e,"video",this.bandwidthConstraints.videobandwidth),"audio",this.bandwidthConstraints.audiobandwidth)},e.prototype.setMediaBitrate=function(e,t,n){for(var r=e.split("\n"),i=-1,o=0;o<r.length;o++)if(0===r[o].indexOf("m="+t)){i=o;break}if(-1===i)return e;for(i++;0===r[i].indexOf("i=")||0===r[i].indexOf("c=");)i++;if(0===r[i].indexOf("b"))return r[i]="b=AS:"+n,r.join("\n");var s=r.slice(0,i);return s.push("b=AS:"+n),(s=s.concat(r.slice(i,r.length))).join("\n")},e.prototype.CreateDataChannel=function(e){var t=new o.DataChannel(e);return this.DataChannels.set(e,t),t},e.prototype.RemoveDataChannel=function(e){this.DataChannels.delete(e)},e.prototype.addError=function(e){this.OnError(e)},e.prototype.onCandidate=function(e){var t=this,n=JSON.parse(e.message).iceCandidate;this.getPeerConnection(e.sender).addIceCandidate(new RTCIceCandidate(n)).then(function(){}).catch(function(e){t.addError(e)})},e.prototype.onAnswer=function(e){var t=this;this.getPeerConnection(e.sender).setRemoteDescription(new RTCSessionDescription(JSON.parse(e.message))).then(function(e){}).catch(function(e){t.addError(e)})},e.prototype.onOffer=function(e){var t=this,n=this.getPeerConnection(e.sender);this.LocalStreams.forEach(function(e){e.getTracks().forEach(function(t){n.addTrack(t,e)})}),n.setRemoteDescription(new RTCSessionDescription(JSON.parse(e.message))),n.createAnswer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(function(r){n.setLocalDescription(r).then(function(){t.bandwidthConstraints&&(r.sdp=t.setMediaBitrates(r.sdp));var n={sender:t.LocalPeerId,recipient:e.sender,message:JSON.stringify(r)};t.brokerController.Invoke("contextSignal",n)}).catch(function(e){return t.addError(e)})}).catch(function(e){return t.addError(e)})},e.prototype.AddLocalStream=function(e){return this.LocalStreams.push(e),this},e.prototype.AddIceServer=function(e){return this.rtcConfig.iceServers.push(e),this},e.prototype.removePeerConnection=function(e){this.Peers.delete(e)},e.prototype.createPeerConnection=function(e){var t=this,n=new RTCPeerConnection(this.rtcConfig);return n.onsignalingstatechange=function(e){},n.onicecandidate=function(n){if(n&&n.candidate&&n.candidate){var r={sender:t.LocalPeerId,recipient:e,message:JSON.stringify({type:"candidate",iceCandidate:n.candidate})};t.brokerController.Invoke("contextSignal",r)}},n.oniceconnectionstatechange=function(n){switch(n.target.iceConnectionState){case"connected":t.onConnected(e);break;case"disconnected":t.OnDisconnected(e)}},n.ontrack=function(n){var r=t.Peers.get(e);r.stream.addTrack(n.track),t.OnRemoteTrack(n.track,r)},this.DataChannels.forEach(function(t){var r=new i.PeerChannel(e,n.createDataChannel(t.Name),t.Name);t.addPeerChannel(r),n.ondatachannel=function(n){var r=n.channel;r.onopen=function(n){t.OnOpen(n,e)},r.onclose=function(n){t.removePeerChannel(e),t.OnClose(n,e)},r.onmessage=function(e){t.onMessage(e)}}}),n},e.prototype.findPeerConnection=function(e){return this.Peers.get(e)},e.prototype.reconnectAll=function(){throw"not yet implemeted"},e.prototype.getPeerConnection=function(e){var t=this.Peers.get(e);if(!t){var n=new r.WebRTCConnection(e,this.createPeerConnection(e));return this.Peers.set(e,n),n.RTCPeer}return t.RTCPeer},e.prototype.createOffer=function(e){var t=this,n=this.createPeerConnection(e.peerId);return this.LocalStreams.forEach(function(e){e.getTracks().forEach(function(t){n.addTrack(t,e)}),t.OnLocalStream(e)}),n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(function(r){n.setLocalDescription(r).then(function(){t.bandwidthConstraints&&(r.sdp=t.setMediaBitrates(r.sdp));var n={sender:t.LocalPeerId,recipient:e.peerId,message:JSON.stringify(r)};t.brokerController.Invoke("contextSignal",n)}).catch(function(e){t.addError(e)})}).catch(function(e){t.addError(e)}),n},e.prototype.Disconnect=function(){this.Peers.forEach(function(e){e.RTCPeer.close()}),this.ChangeContext(Math.random().toString(36).substring(2))},e.prototype.DisconnectPeer=function(e){this.findPeerConnection(e).RTCPeer.close()},e.prototype.Connect=function(e){var t=this;return e.forEach(function(e){var n=new r.WebRTCConnection(e.peerId,t.createOffer(e));t.Peers.set(e.peerId,n)}),this},e.prototype.ChangeContext=function(e){return this.brokerController.Invoke("changeContext",{context:e}),this},e.prototype.ConnectPeers=function(){this.brokerController.Invoke("connectContext",{})},e.prototype.ConnectContext=function(){this.ConnectPeers()},e}();t.WebRTC=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t){this.id=e,this.RTCPeer=t,this.stream=new MediaStream}}();t.WebRTCConnection=r},,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.AppParticipant=class{constructor(e){this.id=e,this.videoTracks=new Array,this.audioTracks=new Array}addVideoTrack(e){this.videoTracks.push(e);let t=new MediaStream([e]);e.onended=(()=>{this.onVideoTrackLost(this.id,t,e)}),this.onVideoTrackAdded(this.id,t,e)}addAudioTrack(e){this.audioTracks.push(e);let t=new Audio;return t.classList.add(".p"+this.id),t.autoplay=!0,t.srcObject=new MediaStream([e]),t}addTrack(e,t){if("video"==e.kind)this.addVideoTrack(e);else{let n=this.addAudioTrack(e);t&&t(n)}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ReadFile=class{static read(e){return new Promise((t,n)=>{let r=new FileReader;r.onerror=n,r.onload=function(e){return function(n){t({buffer:n.target.result,tf:e})}}(e),r.readAsArrayBuffer(e)})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(21),i=n(8);class o{constructor(){this.slugHistory=new r.SlugHistory;const e=localStorage.getItem("settings");if(e){let t=JSON.parse(e);this.audioDevice=t.audioDevice,this.videoDevice=t.videoDevice,this.videoResolution=t.videoResolution,this.nickname=t.nickname,this.slugHistory.history=t.slugHistory}else this.slugHistory.history=new Array,this.nickname=Math.random().toString(36).substring(8),this.audioDevice="",this.videoDevice="",this.videoResolution=""}saveSetting(){const e={slugHistory:this.slugHistory.history,videoDevice:this.videoDevice,audioDevice:this.audioDevice,videoResolution:this.videoResolution,nickname:this.nickname};localStorage.setItem("settings",JSON.stringify(e))}createConstraints(e){let t;if(0===e.length)t={video:{width:{min:640,ideal:1920},height:{min:400,ideal:1080}},audio:!0};else{const n=i.DetectResolutions.getCandidate(e);t={audio:!0,video:{width:{exact:n.width},height:{exact:n.height}}}}return this.audioDevice.length>0&&(t.video.deviceId=this.audioDevice),this.videoDevice.length>0&&(t.video.deviceId=this.videoDevice),console.log(t),t}}o.defaultConstraints={video:{width:{min:640,ideal:1920},height:{min:400,ideal:1080}},audio:!0},t.UserSettings=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SlugHistory=class{constructor(){}getHistory(){return this.history}addToHistory(e){this.history.includes(e)||this.history.push(e)}clearHistory(){this.history=new Array}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(23);t.AppDomain=class{getSlug(e){return`${this.contextPrefix}-${e}`}constructor(){this.domain=r.domain,this.contextPrefix=r.contextPrefix,this.serverUrl=r.serverUrl,this.version=r.version}}},function(e){e.exports={domain:"Kollokvium",contextPrefix:"kollokvium",serverUrl:"wss://kollokvium.herokuapp.com",version:"1.1.3"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(9);t.MediaStreamRecorder=r.MediaStreamRecorder;var i=n(25);t.MediaStreamBlender=i.MediaStreamBlender;var o=n(26);t.MediaLoader=o.MediaLoader;var s=n(10);t.StreamSource=s.StreamSource},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9),i=n(10);t.MediaStreamBlender=class{createVideoFromStream(e){const t=document.createElement("video");return t.srcObject=e,t.muted=!0,t.width=640,t.height=360,t.autoplay=!0,t.play(),t}captureStream(){let e=this.surface.captureStream()||this.surface.mozCaptureStream(),t=new MediaStream;return e.getTracks().filter(function(e){return"video"===e.kind}).forEach(e=>{t.addTrack(e)}),t}addTracks(e,t,n){const r=new MediaStream;return t.forEach(t=>{if("video"===t.kind){r.addTrack(t);let o=new i.StreamSource(r,this.createVideoFromStream(r),n);this.videosSources.set(e,o)}else{this.audioContext||(this.audioContext=new AudioContext,this.audioDestination=this.audioContext.createMediaStreamDestination()),r.addTrack(t);let o=this.audioContext.createMediaStreamSource(r),s=new i.StreamSource(r,o,n);n||o.connect(this.audioDestination),this.audioSources.set(e,s)}t.onended=(()=>{this.onTrackEnded(e,t)})}),this.onTrack(),r}refreshCanvas(){const e=this.videosSources.size;let t=Array.from(this.videosSources.values());this.surface.width=e>1?2*t[0].source.width:t[0].source.width;let n=1;3!==e&&4!==e||(n=2),5!==e&&6!==e||(n=3),7!==e&&8!==e||(n=4),9!==e&&10!==e||(n=5),this.surface.height=t[0].source.height*n}getRemoteAudioStream(){return this.audioDestination=this.audioContext.createMediaStreamDestination(),this.audioSources.forEach(e=>{e.isLocal||e.source.connect(this.audioDestination)}),this.audioDestination.stream}getAllAudioStreams(){return this.audioDestination=this.audioContext.createMediaStreamDestination(),this.audioSources.forEach(e=>{e.source.connect(this.audioDestination)}),this.audioDestination.stream}drawVideo(e,t){let n=0,r=0,i=e.width,o=e.height;1===t&&(n=e.width),2===t&&(r=e.height),3===t&&(n=e.width,r=e.height),4===t&&(r=2*e.height),5===t&&(n=e.width,r=2*e.height),6===t&&(r=3*e.height),7===t&&(n=e.width,r=3*e.height),this.ctx.drawImage(e,n,r,i,o)}constructor(e){this.videosSources=new Map,this.audioSources=new Map,this.surface=e||document.createElement("canvas"),this.ctx=this.surface.getContext("2d")}record(){if(this.isRecording)this.recorder.stop(),this.recorder.flush().then(this.onRecordingEnded);else{let e=this.captureStream().getVideoTracks(),t=this.getAllAudioStreams().getAudioTracks(),n=[e[0],t[0]];this.recorder=new r.MediaStreamRecorder(n),this.recorder.start(10),this.onRecordingStart()}this.isRecording=!this.isRecording}render(e){this.isRendering?(clearInterval(this._handle),this._handle=-1):(this.refreshCanvas(),this._handle=setInterval(()=>{Array.from(this.videosSources.values()).forEach((e,t)=>{this.drawVideo(e.source,t)}),this.onFrameRendered&&this.onFrameRendered(this.ctx)},1e3/e)),this.isRendering=!this.isRendering}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MediaLoader=class{static readFile(e){return new Promise((t,n)=>{fetch(e).then(e=>{t(e.blob())}).catch(n)})}static getAudioMediaStream(e,t){this.readFile(e).then(e=>{var n=new AudioContext,r=n.createGain();r.connect(n.destination),r.gain.value=0;let i=new FileReader;i.onload=function(e){n.decodeAudioData(e.target.result,o)},i.readAsArrayBuffer(e);const o=e=>{let i=n.createBufferSource();i.buffer=e,i.start(0,0),i.connect(r);let o=n.createMediaStreamDestination();i.connect(o),t(o.stream)}})}}}]);